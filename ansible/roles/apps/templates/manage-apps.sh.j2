#!/bin/bash
# Script de gestiÃ³n de aplicaciones React
# Generado automÃ¡ticamente por Ansible

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_menu() {
    echo -e "${BLUE}ğŸ› ï¸  GestiÃ³n de Aplicaciones React${NC}"
    echo "=================================="
    echo ""
    echo "1) ğŸ“Š Estado de aplicaciones"
    echo "2) ğŸ”„ Reiniciar aplicaciones"
    echo "3) ğŸ›‘ Detener aplicaciones"
    echo "4) â–¶ï¸  Iniciar aplicaciones"
    echo "5) ğŸ“ Ver logs en tiempo real"
    echo "6) ğŸ§¹ Limpiar logs"
    echo "7) ğŸ”§ Recargar configuraciÃ³n"
    echo "8) ğŸ“ˆ Monitoreo en tiempo real"
    echo "0) âŒ Salir"
    echo ""
}

app_status() {
    echo -e "${BLUE}ğŸ“Š Estado de aplicaciones${NC}"
    echo "=========================="
    pm2 list
    echo ""
    echo -e "${BLUE}ğŸ“¡ Conectividad:${NC}"
    echo -n "â€¢ Corporativa (3000): "
    if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000 | grep -q "200"; then
        echo -e "${GREEN}âœ… OK${NC}"
    else
        echo -e "${RED}âŒ Error${NC}"
    fi
    
    echo -n "â€¢ Eyenga (3001): "
    if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3001 | grep -q "200"; then
        echo -e "${GREEN}âœ… OK${NC}"
    else
        echo -e "${RED}âŒ Error${NC}"
    fi
}

restart_apps() {
    echo -e "${BLUE}ğŸ”„ Reiniciando aplicaciones${NC}"
    echo "=========================="
    pm2 restart all
    echo -e "${GREEN}âœ… Aplicaciones reiniciadas${NC}"
}

stop_apps() {
    echo -e "${BLUE}ğŸ›‘ Deteniendo aplicaciones${NC}"
    echo "========================="
    pm2 stop all
    echo -e "${YELLOW}âš ï¸  Aplicaciones detenidas${NC}"
}

start_apps() {
    echo -e "${BLUE}â–¶ï¸  Iniciando aplicaciones${NC}"
    echo "========================="
    pm2 start {{ app_directory }}/ecosystem.config.js
    echo -e "${GREEN}âœ… Aplicaciones iniciadas${NC}"
}

watch_logs() {
    echo -e "${BLUE}ğŸ“ Logs en tiempo real${NC}"
    echo "====================="
    echo "Presiona Ctrl+C para salir"
    echo ""
    pm2 logs
}

clean_logs() {
    echo -e "${BLUE}ğŸ§¹ Limpiando logs${NC}"
    echo "================="
    pm2 flush
    echo -e "${GREEN}âœ… Logs limpiados${NC}"
}

reload_config() {
    echo -e "${BLUE}ğŸ”§ Recargando configuraciÃ³n${NC}"
    echo "=========================="
    pm2 reload {{ app_directory }}/ecosystem.config.js
    echo -e "${GREEN}âœ… ConfiguraciÃ³n recargada${NC}"
}

monitor_apps() {
    echo -e "${BLUE}ğŸ“ˆ Monitor PM2${NC}"
    echo "=============="
    pm2 monit
}

# MenÃº principal
while true; do
    show_menu
    read -p "Selecciona una opciÃ³n (0-8): " choice
    
    case $choice in
        1) app_status ;;
        2) restart_apps ;;
        3) stop_apps ;;
        4) start_apps ;;
        5) watch_logs ;;
        6) clean_logs ;;
        7) reload_config ;;
        8) monitor_apps ;;
        0) echo -e "${GREEN}Â¡Hasta luego!${NC}"; exit 0 ;;
        *) echo -e "${RED}OpciÃ³n invÃ¡lida${NC}" ;;
    esac
    
    echo ""
    read -p "Presiona Enter para continuar..."
    clear
done
