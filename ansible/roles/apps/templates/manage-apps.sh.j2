#!/bin/bash
# Script de gestión de aplicaciones React
# Generado automáticamente por Ansible

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_menu() {
    echo -e "${BLUE}🛠️  Gestión de Aplicaciones React${NC}"
    echo "=================================="
    echo ""
    echo "1) 📊 Estado de aplicaciones"
    echo "2) 🔄 Reiniciar aplicaciones"
    echo "3) 🛑 Detener aplicaciones"
    echo "4) ▶️  Iniciar aplicaciones"
    echo "5) 📝 Ver logs en tiempo real"
    echo "6) 🧹 Limpiar logs"
    echo "7) 🔧 Recargar configuración"
    echo "8) 📈 Monitoreo en tiempo real"
    echo "0) ❌ Salir"
    echo ""
}

app_status() {
    echo -e "${BLUE}📊 Estado de aplicaciones${NC}"
    echo "=========================="
    pm2 list
    echo ""
    echo -e "${BLUE}📡 Conectividad:${NC}"
    echo -n "• Corporativa (3000): "
    if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000 | grep -q "200"; then
        echo -e "${GREEN}✅ OK${NC}"
    else
        echo -e "${RED}❌ Error${NC}"
    fi
    
    echo -n "• Eyenga (3001): "
    if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3001 | grep -q "200"; then
        echo -e "${GREEN}✅ OK${NC}"
    else
        echo -e "${RED}❌ Error${NC}"
    fi
}

restart_apps() {
    echo -e "${BLUE}🔄 Reiniciando aplicaciones${NC}"
    echo "=========================="
    pm2 restart all
    echo -e "${GREEN}✅ Aplicaciones reiniciadas${NC}"
}

stop_apps() {
    echo -e "${BLUE}🛑 Deteniendo aplicaciones${NC}"
    echo "========================="
    pm2 stop all
    echo -e "${YELLOW}⚠️  Aplicaciones detenidas${NC}"
}

start_apps() {
    echo -e "${BLUE}▶️  Iniciando aplicaciones${NC}"
    echo "========================="
    pm2 start {{ app_directory }}/ecosystem.config.js
    echo -e "${GREEN}✅ Aplicaciones iniciadas${NC}"
}

watch_logs() {
    echo -e "${BLUE}📝 Logs en tiempo real${NC}"
    echo "====================="
    echo "Presiona Ctrl+C para salir"
    echo ""
    pm2 logs
}

clean_logs() {
    echo -e "${BLUE}🧹 Limpiando logs${NC}"
    echo "================="
    pm2 flush
    echo -e "${GREEN}✅ Logs limpiados${NC}"
}

reload_config() {
    echo -e "${BLUE}🔧 Recargando configuración${NC}"
    echo "=========================="
    pm2 reload {{ app_directory }}/ecosystem.config.js
    echo -e "${GREEN}✅ Configuración recargada${NC}"
}

monitor_apps() {
    echo -e "${BLUE}📈 Monitor PM2${NC}"
    echo "=============="
    pm2 monit
}

# Menú principal
while true; do
    show_menu
    read -p "Selecciona una opción (0-8): " choice
    
    case $choice in
        1) app_status ;;
        2) restart_apps ;;
        3) stop_apps ;;
        4) start_apps ;;
        5) watch_logs ;;
        6) clean_logs ;;
        7) reload_config ;;
        8) monitor_apps ;;
        0) echo -e "${GREEN}¡Hasta luego!${NC}"; exit 0 ;;
        *) echo -e "${RED}Opción inválida${NC}" ;;
    esac
    
    echo ""
    read -p "Presiona Enter para continuar..."
    clear
done
